// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  passwordHash         String
  plan                 String                @default("free")
  service              String                @default("alttext-ai") // Service identifier: 'alttext-ai' or 'seo-ai-meta'
  tokensRemaining      Int                   @default(50)
  credits              Int                   @default(0)
  stripeCustomerId     String?               @unique
  stripeSubscriptionId String?
  resetDate            DateTime              @default(now())
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  usageLogs            UsageLog[]
  migrations           MigrationLog[]
  passwordResets       PasswordResetToken[]
  installations        Installation[]
  organizationMembers  OrganizationMember[]

  @@index([email])
  @@index([stripeCustomerId])
  @@index([service])
  @@map("users")
}

model Organization {
  id                   Int                   @id @default(autoincrement())
  name                 String
  licenseKey           String                @unique @default(uuid())
  plan                 String                @default("free") // free, pro, agency
  service              String                @default("alttext-ai")
  maxSites             Int                   @default(1) // 1 for free/pro, 10 for agency
  tokensRemaining      Int                   @default(50)
  credits              Int                   @default(0)
  stripeCustomerId     String?               @unique
  stripeSubscriptionId String?
  resetDate            DateTime              @default(now())
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  members              OrganizationMember[]
  sites                Site[]
  usageLogs            UsageLog[]

  @@index([licenseKey])
  @@index([stripeCustomerId])
  @@map("organizations")
}

model OrganizationMember {
  id             Int          @id @default(autoincrement())
  organizationId Int
  userId         Int
  role           String       @default("member") // owner, admin, member
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@map("organization_members")
}

model Site {
  id               Int          @id @default(autoincrement())
  organizationId   Int
  siteHash         String       @unique
  siteUrl          String?
  installId        String?      @unique
  isActive         Boolean      @default(true)
  firstSeen        DateTime     @default(now())
  lastSeen         DateTime     @default(now())
  pluginVersion    String?
  wordpressVersion String?
  phpVersion       String?
  isMultisite      Boolean      @default(false)
  metadata         Json?
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([siteHash])
  @@map("sites")
}

model UsageLog {
  id             Int           @id @default(autoincrement())
  userId         Int?
  organizationId Int?
  service        String        @default("alttext-ai") // Service identifier for tracking
  used           Int           @default(1)
  imageId        String?
  endpoint       String?
  createdAt      DateTime      @default(now())
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([userId, service])
  @@index([organizationId, createdAt])
  @@map("usage_logs")
}

model MigrationLog {
  id         Int      @id @default(autoincrement())
  domainHash String   @unique
  userId     Int
  migratedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("migration_logs")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model Installation {
  id               Int                   @id @default(autoincrement())
  installId        String                @unique
  userId           Int
  plan             String                @default("unknown")
  planPriceCents   Int                   @default(0)
  currency         String                @default("usd")
  siteHash         String
  installSecret    String?
  firstSeen        DateTime              @default(now())
  lastSeen         DateTime              @default(now())
  pluginVersion    String?
  wordpressVersion String?
  phpVersion       String?
  isMultisite      Boolean               @default(false)
  metadata         Json?
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageEvents      UsageEvent[]
  dailySummaries   UsageDailySummary[]
  monthlySummaries UsageMonthlySummary[]

  @@index([userId])
  @@map("installations")
}

model UsageEvent {
  id               Int          @id @default(autoincrement())
  installationId   Int
  eventId          String       @unique
  userHash         String
  source           String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  context          Json?
  createdAt        DateTime
  processedAt      DateTime?
  receivedAt       DateTime     @default(now())
  costMicros       BigInt       @default(0)
  revenueCents     Int          @default(0)
  installation     Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@index([installationId, createdAt])
  @@map("usage_events")
}

model UsageDailySummary {
  id               Int          @id @default(autoincrement())
  installationId   Int
  userHash         String
  source           String
  usageDate        DateTime
  totalRequests    Int          @default(0)
  promptTokens     Int          @default(0)
  completionTokens Int          @default(0)
  totalTokens      Int          @default(0)
  costMicros       BigInt       @default(0)
  revenueCents     Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  installation     Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@unique([installationId, userHash, source, usageDate], name: "usage_daily_unique")
  @@index([usageDate])
  @@map("usage_daily_summary")
}

model UsageMonthlySummary {
  id             Int          @id @default(autoincrement())
  installationId Int
  month          String
  totalRequests  Int          @default(0)
  totalTokens    Int          @default(0)
  costMicros     BigInt       @default(0)
  revenueCents   Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  installation   Installation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  @@unique([installationId, month], name: "usage_monthly_unique")
  @@index([month])
  @@map("usage_monthly_summary")
}
